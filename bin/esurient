#!/usr/bin/env bash

#######################################################
# An example runner script for use with the fat jar
# produced by bin/build. Must be executed from a host
# with a Hadoop client installed at HADOOP_HOME and the
# Hadoop *-site.xml files in HADOOP_CONF_DIR.
function green() {
  echo -en "\x1B[32m"
}
function white() {
  echo -en "\x1B[37m"
}
function off() {
  echo -en "\x1B[0m"
}

function runJob() {
  ESURIENT_JAR="$1"
  shift

  green
  echo -n '[*] '
  white
  echo "Esurient Job Executing with args: $@"
  off
  # the path to the job properties file should now be the first of the $@ command-line args
  HADOOP_CLASSPATH=`hadoop classpath` hadoop jar "$ESURIENT_JAR" com.ereisman.esurient.hadoop.EsurientTool $@
  green
  echo -n '[*] '
  white
  echo 'Esurient job completed.'
  off
  echo
  echo
  exit 0
}

function usage() {
  green
  white
  echo " Usage:"
  echo "    $0 -h"
  echo "    $0 [-p path/to/esurient-job.properties] [-j path/to/esurient.jar] [[hadoop-jar-arg] ...]"
  echo 
  echo "           'hadoop-jar-arg' is any number of arguments meant to configure"
  echo "           the 'hadoop jar' call, such as -libjars"
  off
  echo
  exit 1
}

# Assumes we're executing from the bin/ dir. finds repo root dir
pushd "$(dirname $0)/.."
BASEDIR=`pwd -P`
popd

# Default if the user didn't provide a path to the fat jar
JARPATH="$BASEDIR/target/esurient-1.0-SNAPSHOT-jar-with-dependencies.jar" 
JOBPROPS="$BASEDIR/esurient-example-job.properties"

while [[ "$1" == '-j' || "$1" == '-p' ]] ; do
  if [[ "$1" == '-j' ]] ; then
    shift
    if [[ "${1:0:1}" == '/' ]] ; then
      JARPATH="$1"
    else
      JARPATH="$BASEDIR/$1"
    fi
    shift
  fi

  if [[ "$1" == '-p' ]] ; then
    shift
    if [[ "${1:0:1}" == '/' ]] ; then
      JOBPROPS="$1"
    else
      JOBPROPS="$BASEDIR/$1"
    fi
    shift
  fi
done

runJob "$JARPATH" "$JOBPROPS" $@

